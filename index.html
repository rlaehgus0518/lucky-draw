<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw</title>
<style>
  :root{
    --panel:#0f1724; --accent:#ffd166; --text:#f8fafc; --muted:#99a0b2;
    --rowh:48px; /* 기록 한 줄 높이 */
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Apple SD Gothic Neo,"Malgun Gothic",sans-serif;background:#07122a;color:var(--text);}
  .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:22px;padding:32px;box-sizing:border-box}
  /* ★ 타이틀을 결과보다 조금 더 크게 */
  .title{font-size:128px;font-weight:1000;letter-spacing:2px;line-height:1;color:#e8edf7;text-shadow:0 6px 26px rgba(0,0,0,.45)}

  /* 중앙에 추첨기만 배치 */
  .stage{
    width:100%; max-width:1200px;
    display:flex; justify-content:center; align-items:flex-start;
    position:relative;
  }
  .centerStack{display:flex;flex-direction:column;gap:18px;align-items:center}

  /* 롤링 패널 */
  .panel{width:520px;max-width:90vw;border-radius:12px;background:linear-gradient(180deg,#071a2b,#052036);
    display:flex;align-items:center;justify-content:center;padding:18px 20px;box-sizing:border-box;position:relative;overflow:hidden;
    box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  .panel:before{content:"";position:absolute;inset:0;border-radius:12px;box-shadow:inset 0 6px 30px rgba(0,0,0,0.6)}
  .display{display:flex;gap:12px;align-items:center;z-index:2}

  .wheel{
    width:120px;max-width:30vw;background:linear-gradient(180deg,#0a2736,#06202c);
    border-radius:10px;display:flex;align-items:center;justify-content:center;
    overflow:hidden;position:relative;border:2px solid rgba(255,255,255,0.04)
  }
  .digit-strip{
    position:absolute;top:0;left:0;right:0;display:block;transform:translateY(0);
    will-change:transform; backface-visibility:hidden; transform-style:preserve-3d;
  }
  .digit{
    height:48px;line-height:48px;text-align:center;font-weight:800;font-size:44px;color:var(--accent);
    text-shadow:0 2px 8px rgba(0,0,0,0.6); backface-visibility:hidden;
  }

  .wheel::before,.wheel::after{content:"";position:absolute;left:0;right:0;height:28%;pointer-events:none}
  .wheel::before{top:0;background:linear-gradient(to bottom, rgba(7,18,42,.85), rgba(7,18,42,0))}
  .wheel::after{bottom:0;background:linear-gradient(to top, rgba(7,18,42,.85), rgba(7,18,42,0))}

  /* 슬롯머신 중앙 프레임 */
  .focus-frame{
    position:absolute; left:8px; right:8px; margin:auto;
    height:calc(var(--digitH, 48px));
    border:3px solid rgba(255,209,102,.9); border-radius:10px;
    box-shadow:0 0 16px rgba(255,209,102,.25), inset 0 0 8px rgba(255,209,102,.25);
    pointer-events:none;
  }

  /* 버튼 + 큰 결과 */
  .actions{display:flex;gap:10px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:12px 18px;border-radius:12px;color:var(--text);cursor:pointer;font-weight:800}
  .btn.primary{background:var(--accent);color:#081022;border:0}
  .btn:active{transform:translateY(1px)}
  .big-result-wrap{width:520px;max-width:90vw;background:rgba(10,20,35,.55);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px 16px}
  .big-result-title{font-size:13px;color:#d7deef;margin:0 0 6px 0;text-align:center}
  .big-result{font-size:112px;line-height:1;font-weight:1000;letter-spacing:4px;color:#ffe08a;text-shadow:0 6px 24px rgba(0,0,0,.5);text-align:center}

  /* === 오른쪽 끝 고정 기록 박스 (6줄 표시) === */
  .historyDock{
    position:fixed; right:24px; top:170px; width:360px;
    background:rgba(10,20,35,.55);border:1px solid rgba(255,255,255,.06);
    border-radius:12px;padding:12px; backdrop-filter:blur(2px);
    box-shadow:0 10px 30px rgba(2,6,23,.6);
  }
  .historyDock h4{margin:0 0 10px 0;font-size:14px;color:#d7deef;text-align:right}
  .rows{display:flex;flex-direction:column;gap:8px;overflow:auto;max-height:calc(var(--rowh)*6 + 16px);}
  .row{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.06);border-radius:10px;padding:10px 12px;font-size:20px;height:var(--rowh)}
  .row .idx{font-size:12px;color:#b9c2d8;letter-spacing:.5px}
  .clear-line{display:flex;justify-content:flex-end;margin-top:10px}
  .clear{font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:transparent;color:#dbe3f9}

  @media (max-width:980px){
    .historyDock{position:static;width:100%;right:auto;top:auto;margin-top:18px}
    .historyDock h4{text-align:left}
    .wrap{padding:18px}
  }
  @media (max-width:640px){
    .title{font-size:76px}
    .wheel{width:90px} .digit{font-size:36px;height:44px;line-height:44px}
    .big-result{font-size:72px}
  }
  #fx{position:fixed;inset:0;pointer-events:none;z-index:50}
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <div class="title">Lucky Draw</div>

  <div class="stage">
    <!-- 중앙: 추첨기 + 결과 -->
    <div class="centerStack">
      <div class="panel" id="panel">
        <div class="display">
          <div class="wheel" data-pos="h"><div class="digit-strip"></div><div class="focus-frame"></div></div>
          <div class="wheel" data-pos="t"><div class="digit-strip"></div><div class="focus-frame"></div></div>
          <div class="wheel" data-pos="o"><div class="digit-strip"></div><div class="focus-frame"></div></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="drawBtn">추첨</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>

      <div class="big-result-wrap">
        <p class="big-result-title">결과</p>
        <div id="bigResult" class="big-result">—</div>
      </div>
    </div>
  </div>

  <!-- 오른쪽 끝: 기록 -->
  <aside class="historyDock">
    <h4>추첨 기록</h4>
    <div class="rows" id="historyRows"></div>
    <div class="clear-line"><button class="clear" id="clearHistoryBtn">기록 비우기</button></div>
  </aside>
</div>

<script>
(() => {
  const MAX = 100;
  const wheels = [...document.querySelectorAll('.wheel')];
  const wheelH = wheels.find(w => w.dataset.pos === 'h');
  const wheelT = wheels.find(w => w.dataset.pos === 't');
  const wheelO = wheels.find(w => w.dataset.pos === 'o');
  const drawBtn = document.getElementById('drawBtn');
  const resetBtn = document.getElementById('resetBtn');
  const bigResult = document.getElementById('bigResult');
  const rowsEl = document.getElementById('historyRows');
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');

  /* ===== fireworks (3s each, 1s 간격) ===== */
  const fx = document.getElementById('fx'); const ctx = fx.getContext('2d');
  function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; } addEventListener('resize', resizeFx); resizeFx();
  function burst(cx, cy, count=140, duration=3000){
    const ps=[]; for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2, s=2+Math.random()*5;
      ps.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:duration,size:2+Math.random()*3,col:`hsl(${~~(Math.random()*360)},90%,60%)`});
    }
    const start=performance.now();
    function step(t){
      const dt=t-start; ctx.clearRect(0,0,fx.width,fx.height);
      for(const p of ps){ p.vy+=0.02; p.vx*=0.995; p.vy*=0.995; p.x+=p.vx; p.y+=p.vy;
        ctx.globalAlpha=Math.max(0,1-dt/p.life); ctx.fillStyle=p.col;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha=1; if(dt<duration) requestAnimationFrame(step); else ctx.clearRect(0,0,fx.width,fx.height);
    }
    requestAnimationFrame(step);
  }
  function celebrate(){
    const r=document.getElementById('panel').getBoundingClientRect();
    const center=[r.left+r.width/2, r.top+r.height/2];
    burst(...center, 160, 3000);
    setTimeout(()=>burst(innerWidth*0.25, innerHeight*0.35, 120, 3000), 1000);
    setTimeout(()=>burst(innerWidth*0.75, innerHeight*0.35, 120, 3000), 2000);
  }

  // 숫자 높이
  const digitHeight = () => document.querySelector('.digit').getBoundingClientRect().height;

  // 휠 구성: 0~9
  function buildStrip(wheel){
    const strip = wheel.querySelector('.digit-strip'); strip.innerHTML='';
    for(let r=0;r<10;r++){ for(let d=0; d<10; d++){
      const el=document.createElement('div'); el.className='digit'; el.textContent=d; strip.appendChild(el);
    }}
  }
  wheels.forEach(buildStrip);

  // 3칸 보기
  function applyViewportHeight(){
    const h = digitHeight();
    document.documentElement.style.setProperty('--digitH', `${h}px`);
    wheels.forEach(w => { w.style.height = `${h*3}px`; });
  }

  // 감속 멈춤용 이징
  const EASE_OUT = 'cubic-bezier(.08,.72,.12,.99)';

  const VISIBLE_REP = 4, TARGET_REP = 9, baseLen = 10; // 더 멀리 돌고(9회전 베이스), 감속

  // 현재 인덱스 추출 (재시작 시 연속 회전감 유지)
  function currentIndex(wheel){
    const tr = getComputedStyle(wheel.querySelector('.digit-strip')).transform;
    const h = digitHeight();
    let ty = 0;
    if(tr && tr !== 'none'){
      const m = tr.match(/matrix.*\((.+)\)/);
      if(m){ const p = m[1].split(','); ty = parseFloat(p[5]||0); }
    }
    return -ty / h;
  }

  function moveToIndex(wheel, index, duration){
    return new Promise(res=>{
      const strip=wheel.querySelector('.digit-strip');
      strip.style.transition = `transform ${duration}ms ${EASE_OUT}`;
      requestAnimationFrame(()=>{ strip.style.transform=`translate3d(0, ${-index*digitHeight()}px, 0)`; });
      const end=()=>{ strip.removeEventListener('transitionend', end); res(); };
      strip.addEventListener('transitionend', end);
    });
  }

  function visibleBaseIndex(digit){ return VISIBLE_REP*baseLen + digit - 1; } // 가운데가 현재값

  async function spinToDigit(wheel, digit, extraLoops, duration){
    const startIdx = currentIndex(wheel);
    const targetIdx = (TARGET_REP+extraLoops)*baseLen + (digit - 1); // 위에 1칸(이전값) 포함
    // 시작지점에서 목표까지 연속 감속 이동
    await moveToIndex(wheel, targetIdx, duration);
    // 내부 인덱스 리베이스(같은 위치로 스냅 없는 재정렬)
    const strip=wheel.querySelector('.digit-strip');
    strip.style.transition='none';
    const baseIdx = visibleBaseIndex(digit);
    strip.style.transform = `translate3d(0, ${-baseIdx*digitHeight()}px, 0)`;
  }

  function setInstant(wheel, digit){
    const strip=wheel.querySelector('.digit-strip'); strip.style.transition='none';
    strip.style.transform=`translate3d(0, ${-visibleBaseIndex(digit)*digitHeight()}px, 0)`;
  }

  function split(n){ n=Math.max(1,Math.min(100,Math.round(n))); return [Math.floor(n/100), Math.floor((n%100)/10), n%10]; }
  function randomDraw(){ return Math.floor(Math.random()*100)+1; }
  const pad3 = n => (n===100 ? "100" : String(n).padStart(3,'0'));

  // 기록
  const history=[];
  function renderHistory(){
    rowsEl.innerHTML='';
    history.forEach((v,i)=>{
      const row=document.createElement('div'); row.className='row';
      const left=document.createElement('span'); left.textContent=String(v);
      const idx=document.createElement('span'); idx.className='idx'; idx.textContent=`#${i+1}`;
      row.appendChild(left); row.appendChild(idx); rowsEl.appendChild(row);
    });
    rowsEl.scrollTop = rowsEl.scrollHeight;
  }
  function addHistory(n){ history.push(n); if(history.length>300) history.shift(); renderHistory(); }
  clearHistoryBtn.addEventListener('click', ()=>{ history.length=0; renderHistory(); });

  let spinning=false;
  async function spinTo(n){
    if(spinning) return; spinning=true;
    n=Math.max(1,Math.min(100,n));
    const [h,t,o]=split(n);
    const targetH = (n===100?1:0), targetT = (n===100?0:t), targetO = (n===100?0:o);

    // ★ 더 길고, 감속하면서 차례로 멈춤
    await Promise.all([
      spinToDigit(wheelH, targetH, 4, 2600),  // 먼저 멈춤
      (async()=>{ await new Promise(r=>setTimeout(r,120)); await spinToDigit(wheelT, targetT, 5, 3000); })(),
      (async()=>{ await new Promise(r=>setTimeout(r,240)); await spinToDigit(wheelO, targetO, 6, 3400); })(),
    ]);

    bigResult.textContent = pad3(n);
    addHistory(n);
    celebrate();
    spinning=false; drawBtn.disabled=false;
  }

  document.getElementById('panel').addEventListener('click', ()=>{ if(!drawBtn.disabled) drawBtn.click(); });
  drawBtn.addEventListener('click', ()=>{ if(spinning) return; drawBtn.disabled=true; bigResult.textContent='...'; spinTo(randomDraw()); });
  resetBtn.addEventListener('click', ()=>{
    setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0);
    bigResult.textContent='—'; drawBtn.disabled=false; spinning=false;
  });

  function init(){
    // 높이 세팅 후 000으로 정렬
    const h = digitHeight();
    document.documentElement.style.setProperty('--digitH', `${h}px`);
    setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0);
  }
  window.addEventListener('load', ()=>{ applyViewportHeight(); init(); });
  function applyViewportHeight(){
    const h = digitHeight();
    document.documentElement.style.setProperty('--digitH', `${h}px`);
    wheels.forEach(w => { w.style.height = `${h*3}px`; });
  }
  window.addEventListener('resize', ()=>{ applyViewportHeight(); init(); });
})();
</script>
</body>
</html>
