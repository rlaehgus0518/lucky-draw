<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw</title>
<style>
  :root{ --accent:#ffd166; --text:#f8fafc; --rowh:48px; }
  html,body{height:100%;margin:0;font-family:Inter,"Malgun Gothic",sans-serif;background:#07122a;color:#f8fafc;}
  .wrap{min-height:100vh;display:flex;flex-direction:column;align-items:center;gap:22px;padding:32px;box-sizing:border-box}
  .title{font-size:128px;font-weight:1000;color:#e8edf7;text-shadow:0 6px 26px rgba(0,0,0,.45)}
  .panel{width:520px;max-width:90vw;border-radius:12px;background:linear-gradient(180deg,#071a2b,#052036);
    display:flex;align-items:center;justify-content:center;padding:18px 20px;box-sizing:border-box;overflow:hidden;
    box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  .display{display:flex;gap:12px;align-items:center;}
  .wheel{width:120px;background:linear-gradient(180deg,#0a2736,#06202c);
    border-radius:10px;display:flex;align-items:center;justify-content:center;
    overflow:hidden;position:relative;border:2px solid rgba(255,255,255,0.04)}
  .digit-strip{position:absolute;top:0;left:0;right:0;display:block;transform:translateY(0);will-change:transform;backface-visibility:hidden;}
  .digit{height:48px;line-height:48px;text-align:center;font-weight:800;font-size:44px;color:var(--accent);
    text-shadow:0 2px 8px rgba(0,0,0,0.6);transition:transform 120ms ease-out;}
  .digit.current{transform:scale(1.3);font-weight:1000;}
  .wheel::before,.wheel::after{content:"";position:absolute;left:0;right:0;height:28%;pointer-events:none}
  .wheel::before{top:0;background:linear-gradient(to bottom,rgba(7,18,42,.85),rgba(7,18,42,0))}
  .wheel::after{bottom:0;background:linear-gradient(to top,rgba(7,18,42,.85),rgba(7,18,42,0))}
  .focus-frame{position:absolute;left:8px;right:8px;margin:auto;height:calc(var(--digitH,48px));border:3px solid rgba(255,209,102,.9);
    border-radius:10px;box-shadow:0 0 16px rgba(255,209,102,.25),inset 0 0 8px rgba(255,209,102,.25);pointer-events:none;}
  .actions{display:flex;gap:10px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:12px 18px;border-radius:12px;color:#fff;cursor:pointer;font-weight:800}
  .btn.primary{background:var(--accent);color:#081022;border:0}
  .btn:active{transform:translateY(1px)}
  .big-result{font-size:112px;font-weight:1000;letter-spacing:4px;color:#ffe08a;text-shadow:0 6px 24px rgba(0,0,0,.5)}
  #fx{position:fixed;inset:0;pointer-events:none;z-index:50}
</style>
</head>
<body>
<canvas id="fx"></canvas>
<div class="wrap">
  <div class="title">Lucky Draw</div>
  <div class="panel" id="panel">
    <div class="display">
      <div class="wheel"><div class="digit-strip"></div><div class="focus-frame"></div></div>
      <div class="wheel"><div class="digit-strip"></div><div class="focus-frame"></div></div>
      <div class="wheel"><div class="digit-strip"></div><div class="focus-frame"></div></div>
    </div>
  </div>
  <div class="actions">
    <button class="btn primary" id="drawBtn">추첨</button>
    <button class="btn" id="resetBtn">Reset</button>
  </div>
  <div id="bigResult" class="big-result">—</div>
</div>

<script>
(() => {
  // ===== 기본 엘리먼트 =====
  const wheels=[...document.querySelectorAll('.wheel')];
  const [wheelH,wheelT,wheelO]=wheels;
  const drawBtn=document.getElementById('drawBtn');
  const resetBtn=document.getElementById('resetBtn');
  const bigResult=document.getElementById('bigResult');

  // ===== 폭죽 =====
  const fx=document.getElementById('fx'),ctx=fx.getContext('2d');
  function resizeFx(){fx.width=innerWidth;fx.height=innerHeight;} addEventListener('resize',resizeFx); resizeFx();
  function burst(x,y,count=120,dur=3000){const ps=[];for(let i=0;i<count;i++){const a=Math.random()*Math.PI*2,s=2+Math.random()*5;
    ps.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:dur,size:2+Math.random()*3,col:`hsl(${~~(Math.random()*360)},90%,60%)`});}
    const start=performance.now();function step(t){const dt=t-start;ctx.clearRect(0,0,fx.width,fx.height);
      for(const p of ps){p.vy+=0.02;p.vx*=0.995;p.vy*=0.995;p.x+=p.vx;p.y+=p.vy;ctx.globalAlpha=Math.max(0,1-dt/p.life);
        ctx.fillStyle=p.col;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();}
      ctx.globalAlpha=1;if(dt<dur)requestAnimationFrame(step);}requestAnimationFrame(step);}
  function celebrate(){const r=document.getElementById('panel').getBoundingClientRect();
    burst(r.left+r.width/2,r.top+r.height/2,160,3000);
    setTimeout(()=>burst(innerWidth*0.25,innerHeight*0.35,120,3000),1000);
    setTimeout(()=>burst(innerWidth*0.75,innerHeight*0.35,120,3000),2000);}

  // ===== 숫자 스트립/뷰포트 =====
  const STRIP_REP=30, baseLen=10, EASE='cubic-bezier(.08,.72,.12,.99)';
  function buildStrip(w){const s=w.querySelector('.digit-strip');s.innerHTML='';for(let r=0;r<STRIP_REP;r++){for(let d=0;d<10;d++){const e=document.createElement('div');e.className='digit';e.textContent=d;s.appendChild(e);}}}
  wheels.forEach(buildStrip);

  const digitHeight=()=>document.querySelector('.digit').getBoundingClientRect().height;
  function applyH(){const h=digitHeight();document.documentElement.style.setProperty('--digitH',`${h}px`);wheels.forEach(w=>w.style.height=`${h*3}px`);}
  const visibleBaseIndex=d=>4*baseLen+(d-1);

  function markCurrent(w){
    const s=w.querySelector('.digit-strip');
    const center=w.getBoundingClientRect().top + w.getBoundingClientRect().height/2;
    const ds=[...s.children]; let best=null,dist=1e9;
    for(const d of ds){const r=d.getBoundingClientRect(),m=r.top+r.height/2;const dv=Math.abs(m-center);
      if(dv<dist){dist=dv;best=d;} d.classList.remove('current');}
    if(best) best.classList.add('current');
  }

  function setInstant(w,digit=0){
    const s=w.querySelector('.digit-strip');
    s.style.transition='none';
    s.style.transform=`translate3d(0,${-visibleBaseIndex(digit)*digitHeight()}px,0)`;
    markCurrent(w);
  }

  // ===== 핵심: 매회 3초 고정 애니메이션 =====
  // 1) transition 완전 제거 → 2) 강제 리플로우 → 3) 3000ms transition 재적용 → 4) 목표로 이동
  function moveToIndex(w,index,duration){
    return new Promise(resolve=>{
      const s=w.querySelector('.digit-strip');
      // 완전 리셋
      s.style.transition='none';
      void s.offsetWidth; // reflow
      // 3000ms 고정 적용
      s.style.transition=`transform ${duration}ms ${EASE}`;
      requestAnimationFrame(()=>{
        s.style.transform=`translate3d(0,${-index*digitHeight()}px,0)`;
      });
      s.addEventListener('transitionend',()=>resolve(),{once:true});
    });
  }

  async function spinToDigit(w,dig,loops,dur){
    const s=w.querySelector('.digit-strip');
    w.querySelectorAll('.digit').forEach(d=>d.classList.remove('current'));
    const idx=(loops*baseLen)+(dig-1);        // 충분히 도는 거리
    await moveToIndex(w, idx, dur);           // ★ 항상 dur(3000ms) 사용
    // 멈춘 뒤 중앙으로 스냅(transition 없음)
    s.style.transition='none';
    s.style.transform=`translate3d(0,${-visibleBaseIndex(dig)*digitHeight()}px,0)`;
    markCurrent(w);
  }

  // 숫자 헬퍼
  function split(n){n=Math.max(1,Math.min(100,n));return[Math.floor(n/100),Math.floor((n%100)/10),n%10];}
  const pad3=n=>n===100?"100":String(n).padStart(3,'0');

  // 각 자리 3초 고정
  const SPIN_H=3000, SPIN_T=3000, SPIN_O=3000;
  // 회전수(시각적으로 충분히 도는 느낌)
  const LOOPS_H=8, LOOPS_T=9, LOOPS_O=10;

  let spinning=false;
  async function spinTo(n){
    if(spinning) return; spinning=true;

    // 매 회차 시작 시: 뷰포트 보정 + transition 초기화
    applyH();
    [wheelH,wheelT,wheelO].forEach(w=>{
      const s=w.querySelector('.digit-strip');
      s.style.transition='none';
      void s.offsetWidth;
    });

    n=Math.max(1,Math.min(100,n));
    const [h,t,o]=split(n);
    const H=(n===100?1:0), T=(n===100?0:t), O=(n===100?0:o);

    // ★ 백(3초) → 십(3초) → 일(3초) 순서로 정확히 3초씩
    await spinToDigit(wheelH, H, LOOPS_H, SPIN_H);
    await spinToDigit(wheelT, T, LOOPS_T, SPIN_T);
    await spinToDigit(wheelO, O, LOOPS_O, SPIN_O);

    bigResult.textContent = pad3(n);
    celebrate();
    spinning=false; drawBtn.disabled=false;
  }

  // 바인딩
  drawBtn.onclick=()=>{ if(spinning) return; drawBtn.disabled=true; bigResult.textContent='...'; spinTo(Math.floor(Math.random()*100)+1); };
  resetBtn.onclick=()=>{ [wheelH,wheelT,wheelO].forEach(w=>setInstant(w,0)); bigResult.textContent='—'; spinning=false; drawBtn.disabled=false; };

  // 초기화
  function init(){ applyH(); setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0); }
  window.addEventListener('load', init);
  window.addEventListener('resize', ()=>{ applyH(); setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0); });
})();
</script>
</body>
</html>
