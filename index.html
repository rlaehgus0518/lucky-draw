<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw</title>
<style>
  :root{
    --panel:#0f1724;
    --accent:#ffd166;
    --text:#f8fafc;
    --muted:#99a0b2;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Apple SD Gothic Neo,"Malgun Gothic",sans-serif;background:#07122a;color:var(--text);}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;box-sizing:border-box;flex-direction:column;gap:22px}
  .title{font-size:24px;letter-spacing:1px;color:#cfd6e6;font-weight:800}
  .stage{background:linear-gradient(180deg,#081226 0%, #0f1a2b 100%);border-radius:14px;padding:28px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:flex;align-items:center;gap:18px}

  /* display panel */
  .panel{width:520px;height:160px;border-radius:10px;background:linear-gradient(180deg,#071a2b,#052036);display:flex;align-items:center;justify-content:center;padding:18px 20px;box-sizing:border-box;position:relative;overflow:hidden}
  .panel:before{content:"";position:absolute;inset:0;border-radius:10px;box-shadow:inset 0 6px 30px rgba(0,0,0,0.6)}
  .display{display:flex;gap:10px;align-items:flex-end;z-index:2}
  .wheel{
    width:120px;height:120px;background:linear-gradient(180deg,#0a2736,#06202c);border-radius:8px;display:flex;align-items:center;justify-content:center;
    overflow:hidden;position:relative;border:2px solid rgba(255,255,255,0.03);
  }
  .digit-strip{position:absolute;top:0;left:0;right:0;display:block;transform:translateY(0)}
  .digit{height:48px;line-height:48px;text-align:center;font-weight:800;font-size:44px;color:var(--accent);text-shadow:0 2px 8px rgba(0,0,0,0.6)}
  .label{position:absolute;left:10px;top:10px;color:var(--muted);font-size:12px}

  /* controls */
  .controls{display:flex;flex-direction:column;gap:8px;margin-left:14px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:10px 18px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#081022;border:0}
  .btn:active{transform:translateY(1px)}
  .small{font-size:13px;color:var(--muted)}

  @media (max-width:640px){
    .panel{width:100%;height:120px}
    .wheel{width:90px;height:96px}
    .digit{font-size:36px;height:44px;line-height:44px}
    .display{gap:6px}
  }

  /* fireworks canvas */
  #fx { position:fixed; inset:0; pointer-events:none; z-index:50; }
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <div class="title">Lucky Draw</div>

  <div class="stage">
    <div class="panel" id="panel">
      <div class="display" id="display">
        <!-- 3 wheels (hundreds, tens, ones) -->
        <div class="wheel" data-pos="h">
          <div class="label">100s</div>
          <div class="digit-strip"></div>
        </div>
        <div class="wheel" data-pos="t">
          <div class="label">10s</div>
          <div class="digit-strip"></div>
        </div>
        <div class="wheel" data-pos="o">
          <div class="label">1s</div>
          <div class="digit-strip"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div style="display:flex;gap:8px">
        <button class="btn primary" id="drawBtn">추첨</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
      <div class="small">결과: <span id="resultText">—</span></div>
    </div>
  </div>
</div>

<script>
(() => {
  const MAX = 100;               // 1 ~ MAX
  const wheels = Array.from(document.querySelectorAll('.wheel'));
  const wheelH = wheels.find(w => w.dataset.pos === 'h');
  const wheelT = wheels.find(w => w.dataset.pos === 't');
  const wheelO = wheels.find(w => w.dataset.pos === 'o');

  const resultText = document.getElementById('resultText');
  const drawBtn = document.getElementById('drawBtn');
  const resetBtn = document.getElementById('resetBtn');

  // 고정 높이(px) – CSS의 .digit 높이와 동일
  const DIGIT_H = 48;

  // ==== fireworks (3초) ====
  const fx = document.getElementById('fx');
  const ctx = fx.getContext('2d');
  function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; }
  addEventListener('resize', resizeFx); resizeFx();

  function fireworksBurst(cx, cy, count=140, duration=3000){ // 3초
    const parts = [];
    for(let i=0;i<count;i++){
      const angle = Math.random()*Math.PI*2;
      const speed = 2 + Math.random()*5;
      parts.push({
        x:cx, y:cy,
        vx: Math.cos(angle)*speed,
        vy: Math.sin(angle)*speed,
        life: duration,
        size: 2 + Math.random()*3,
        col: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`
      });
    }
    const start = performance.now();
    function step(now){
      const t = now - start;
      ctx.clearRect(0,0,fx.width,fx.height);
      parts.forEach(p=>{
        p.vy += 0.02;
        p.vx *= 0.995; p.vy *= 0.995;
        p.x += p.vx; p.y += p.vy;
        const alpha = Math.max(0, 1 - t/p.life);
        ctx.globalAlpha = alpha;
        ctx.fillStyle = p.col;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
      });
      ctx.globalAlpha = 1;
      if(t < duration) requestAnimationFrame(step);
      else ctx.clearRect(0,0,fx.width,fx.height);
    }
    requestAnimationFrame(step);
  }
  function celebrate(){
    const rect = document.getElementById('panel').getBoundingClientRect();
    fireworksBurst(rect.left + rect.width/2, rect.top + rect.height/2, 160, 3000);
    setTimeout(()=>fireworksBurst(innerWidth*0.25, innerHeight*0.3, 120, 3000), 200);
    setTimeout(()=>fireworksBurst(innerWidth*0.75, innerHeight*0.35, 120, 3000), 400);
  }
  // ==========================

  function buildStrip(stripEl){
    stripEl.innerHTML = '';
    for(let r=0;r<5;r++){
      for(let d=0;d<10;d++){
        const div = document.createElement('div');
        div.className = 'digit';
        div.textContent = d;
        stripEl.appendChild(div);
      }
    }
  }
  wheels.forEach(w => buildStrip(w.querySelector('.digit-strip')));

  function setWheelInstant(wheel, digit){
    const strip = wheel.querySelector('.digit-strip');
    strip.style.transition = 'none';
    const rep = 2; // 안정적인 가시 반복
    const idx = rep * 10 + digit;
    strip.style.transform = `translateY(${-idx * DIGIT_H}px)`;
  }

  // transition 종료를 Promise로
  function spinWheel(wheel, digit, loops, duration){
    return new Promise(resolve=>{
      const strip = wheel.querySelector('.digit-strip');
      const repIndex = 3;
      const totalIndex = repIndex * 10 + digit;
      const translateY = -((loops * 10) + totalIndex) * DIGIT_H;

      strip.style.transition = `transform ${duration}ms cubic-bezier(.18,.82,.18,1)`;
      requestAnimationFrame(() => {
        strip.style.transform = `translateY(${translateY}px)`;
      });

      const onEnd = () => {
        strip.style.transition = 'none';
        const finalRep = 2;
        const finalIdx = finalRep * 10 + digit;
        strip.style.transform = `translateY(${-finalIdx * DIGIT_H}px)`;
        strip.removeEventListener('transitionend', onEnd);
        resolve();
      };
      strip.addEventListener('transitionend', onEnd);
    });
  }

  function splitNumber(n){
    n = Math.max(1, Math.min(MAX, Math.round(n)));
    const ones = n % 10;
    const tens = Math.floor((n % 100) / 10);
    const hundreds = Math.floor(n / 100); // 0 또는 1
    return [hundreds, tens, ones];
  }

  let spinning = false;       // 동시 클릭 방지
  let currentValue = null;    // 이번 라운드 결과

  async function spinTo(n){
    if (spinning) return;
    spinning = true;
    currentValue = n;

    const [h,t,o] = splitNumber(n);
    // 세 자리 모두 회전 (백의 자리도 항상 회전)
    const pH = spinWheel(wheelH, (n===100?1:0), 4, 1700);
    const pT = spinWheel(wheelT, t, 5, 1800);
    const pO = spinWheel(wheelO, o, 6, 2000);

    await Promise.all([pH,pT,pO]);

    // ✅ 최종 강제 정렬(표시값과 결과 100% 동기화)
    setWheelInstant(wheelH, (n===100?1:0));
    setWheelInstant(wheelT, t);
    setWheelInstant(wheelO, o);

    resultText.textContent = String(n);
    celebrate();
    spinning = false;
    drawBtn.disabled = false;
  }

  function randomDraw(){
    return Math.floor(Math.random() * MAX) + 1; // 1..100
  }

  document.getElementById('panel').addEventListener('click', () => {
    if(!drawBtn.disabled) drawBtn.click();
  });

  drawBtn.addEventListener('click', () => {
    if (spinning) return;
    drawBtn.disabled = true;
    resultText.textContent = '...';
    const val = randomDraw();
    spinTo(val);
  });

  resetBtn.addEventListener('click', () => {
    setWheelInstant(wheelH, 0);
    setWheelInstant(wheelT, 0);
    setWheelInstant(wheelO, 0);
    resultText.textContent = '—';
    drawBtn.disabled = false;
    spinning = false;
    currentValue = null;
  });

  window.addEventListener('load', () => {
    resetBtn.click();
  });
})();
</script>
</body>
</html>
