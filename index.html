<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucky Draw</title>
<style>
  :root{ --panel:#0f1724; --accent:#ffd166; --text:#f8fafc; --muted:#99a0b2; }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Apple SD Gothic Neo,"Malgun Gothic",sans-serif;background:#07122a;color:var(--text);}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;box-sizing:border-box;flex-direction:column;gap:22px}
  .title{font-size:42px;font-weight:900;letter-spacing:1px;color:#e8edf7;text-shadow:0 4px 20px rgba(0,0,0,.45)}
  .stage{background:linear-gradient(180deg,#081226 0%, #0f1a2b 100%);border-radius:14px;padding:28px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:flex;align-items:center;gap:18px}

  /* 패널 */
  .panel{width:520px;border-radius:10px;background:linear-gradient(180deg,#071a2b,#052036);display:flex;align-items:center;justify-content:center;padding:18px 20px;box-sizing:border-box;position:relative;overflow:hidden}
  .panel:before{content:"";position:absolute;inset:0;border-radius:10px;box-shadow:inset 0 6px 30px rgba(0,0,0,0.6)}
  .display{display:flex;gap:10px;align-items:center;z-index:2}

  /* 휠 – 높이는 JS가 숫자 실측값으로 세팅해서 1칸만 보이게 함 */
  .wheel{
    width:120px; background:linear-gradient(180deg,#0a2736,#06202c);
    border-radius:8px; display:flex; align-items:center; justify-content:center;
    overflow:hidden; position:relative; border:2px solid rgba(255,255,255,0.03)
  }
  .digit-strip{position:absolute;top:0;left:0;right:0;display:block;transform:translateY(0);will-change:transform}
  .digit{height:48px;line-height:48px;text-align:center;font-weight:800;font-size:44px;color:var(--accent);text-shadow:0 2px 8px rgba(0,0,0,0.6)}
  .label{position:absolute;left:10px;top:10px;color:var(--muted);font-size:12px}

  .controls{display:flex;flex-direction:column;gap:8px;margin-left:14px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:10px 18px;border-radius:10px;color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#081022;border:0}
  .btn:active{transform:translateY(1px)}
  .small{font-size:13px;color:var(--muted)}
  @media (max-width:640px){
    .panel{width:100%} .wheel{width:90px} .digit{font-size:36px;height:44px;line-height:44px}
    .title{font-size:30px}
  }
  #fx{position:fixed;inset:0;pointer-events:none;z-index:50}
</style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="wrap">
  <div class="title">Lucky Draw</div>

  <div class="stage">
    <div class="panel" id="panel">
      <div class="display">
        <div class="wheel" data-pos="h"><div class="label">100s</div><div class="digit-strip"></div></div>
        <div class="wheel" data-pos="t"><div class="label">10s</div><div class="digit-strip"></div></div>
        <div class="wheel" data-pos="o"><div class="label">1s</div><div class="digit-strip"></div></div>
      </div>
    </div>

    <div class="controls">
      <div style="display:flex;gap:8px">
        <button class="btn primary" id="drawBtn">추첨</button>
        <button class="btn" id="resetBtn">Reset</button>
      </div>
      <div class="small">결과: <span id="resultText">—</span></div>
    </div>
  </div>
</div>

<script>
(() => {
  const MAX = 100;
  const wheels = [...document.querySelectorAll('.wheel')];
  const wheelH = wheels.find(w => w.dataset.pos === 'h');
  const wheelT = wheels.find(w => w.dataset.pos === 't');
  const wheelO = wheels.find(w => w.dataset.pos === 'o');
  const resultText = document.getElementById('resultText');
  const drawBtn = document.getElementById('drawBtn');
  const resetBtn = document.getElementById('resetBtn');

  // ===== fireworks (3s each, 1s 간격 순차) =====
  const fx = document.getElementById('fx'); const ctx = fx.getContext('2d');
  function resizeFx(){ fx.width = innerWidth; fx.height = innerHeight; }
  addEventListener('resize', resizeFx); resizeFx();
  function burst(cx, cy, count=140, duration=3000){
    const ps=[]; for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2, s=2+Math.random()*5;
      ps.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:duration,size:2+Math.random()*3,col:`hsl(${~~(Math.random()*360)},90%,60%)`});
    }
    const start=performance.now();
    function step(t){
      const dt=t-start; ctx.clearRect(0,0,fx.width,fx.height);
      for(const p of ps){ p.vy+=0.02; p.vx*=0.995; p.vy*=0.995; p.x+=p.vx; p.y+=p.vy;
        ctx.globalAlpha=Math.max(0,1-dt/p.life); ctx.fillStyle=p.col;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha=1; if(dt<duration) requestAnimationFrame(step); else ctx.clearRect(0,0,fx.width,fx.height);
    }
    requestAnimationFrame(step);
  }
  function celebrate(){
    const r=document.getElementById('panel').getBoundingClientRect();
    const center=[r.left+r.width/2, r.top+r.height/2];
    // 순차: 0ms, +1000ms, +2000ms
    burst(...center, 160, 3000);
    setTimeout(()=>burst(innerWidth*0.25, innerHeight*0.35, 120, 3000), 1000);
    setTimeout(()=>burst(innerWidth*0.75, innerHeight*0.35, 120, 3000), 2000);
  }
  // ===============================================

  // 숫자 한 칸만 보이게: 실측 높이로 휠 높이 맞춤
  function digitHeight(){ return document.querySelector('.digit').getBoundingClientRect().height; }
  function applyViewportHeight(){
    const h = digitHeight();
    wheels.forEach(w => { w.style.height = `${h}px`; }); // 1칸만 보이도록
  }

  // 휠 구성: 백의 자리(0/1만), 나머지(0~9)
  function buildStrip(wheel){
    const strip = wheel.querySelector('.digit-strip'); strip.innerHTML='';
    const isH = wheel.dataset.pos === 'h';
    const digits = isH ? [0,1] : [0,1,2,3,4,5,6,7,8,9];
    for(let r=0;r<10;r++){ for(const d of digits){
      const el=document.createElement('div'); el.className='digit'; el.textContent=d; strip.appendChild(el);
    }}
  }
  wheels.forEach(buildStrip);

  // 인덱스 계산 유틸 (가시 반복 / 목표 반복)
  const VISIBLE_REP = 4;
  const TARGET_REP  = 6;
  function wheelBase(wheel){ return (wheel.dataset.pos==='h'?2:10); }

  function setInstant(wheel, digit){
    const strip=wheel.querySelector('.digit-strip'); strip.style.transition='none';
    const h=digitHeight(); const len=wheelBase(wheel);
    const idx = VISIBLE_REP*len + digit;
    strip.style.transform=`translate3d(0, ${-idx*h}px, 0)`;
  }

  function spinToDigit(wheel, digit, loops, duration){
    return new Promise(resolve=>{
      const strip=wheel.querySelector('.digit-strip');
      const h=digitHeight(); const len=wheelBase(wheel);
      const totalIndex = TARGET_REP*len + digit;
      const translateY = -((loops*len) + totalIndex) * h;
      strip.style.transition = `transform ${duration}ms cubic-bezier(.18,.82,.18,1)`;
      requestAnimationFrame(()=>{ strip.style.transform=`translate3d(0, ${translateY}px, 0)`; });
      const onEnd=()=>{ strip.style.transition='none';
        // 최종 강제 정렬 (실측 높이 사용)
        const idx=VISIBLE_REP*len + digit;
        strip.style.transform=`translate3d(0, ${-idx*h}px, 0)`;
        strip.removeEventListener('transitionend', onEnd);
        resolve();
      };
      strip.addEventListener('transitionend', onEnd);
    });
  }

  function split(n){ n=Math.max(1,Math.min(MAX,Math.round(n))); return [Math.floor(n/100), Math.floor((n%100)/10), n%10]; }

  let spinning=false;
  async function spinTo(n){
    if(spinning) return; spinning=true;
    n=Math.max(1,Math.min(MAX,n));
    const [h,t,o]=split(n);

    const targetH = (n===100?1:0);
    const targetT = (n===100?0:t);
    const targetO = (n===100?0:o);

    const pH=spinToDigit(wheelH, targetH, 6, 1700);
    const pT=spinToDigit(wheelT, targetT, 7, 1850);
    const pO=spinToDigit(wheelO, targetO, 8, 2050);

    await Promise.all([pH,pT,pO]);

    // 표시값과 결과 완전 동기화 (한 번 더 고정)
    setInstant(wheelH, targetH);
    setInstant(wheelT, targetT);
    setInstant(wheelO, targetO);

    resultText.textContent=String(n);
    celebrate();
    spinning=false; drawBtn.disabled=false;
  }

  function randomDraw(){ return Math.floor(Math.random()*MAX)+1; } // 1..100

  document.getElementById('panel').addEventListener('click', ()=>{ if(!drawBtn.disabled) drawBtn.click(); });
  drawBtn.addEventListener('click', ()=>{ if(spinning) return; drawBtn.disabled=true; resultText.textContent='...'; spinTo(randomDraw()); });
  resetBtn.addEventListener('click', ()=>{ setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0); resultText.textContent='—'; drawBtn.disabled=false; spinning=false; });

  function init(){
    applyViewportHeight();
    setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0);
  }
  window.addEventListener('load', init);
  window.addEventListener('resize', ()=>{ applyViewportHeight(); /* 높이가 바뀌면 위치 재고정 */ setInstant(wheelH,0); setInstant(wheelT,0); setInstant(wheelO,0); });
})();
</script>
</body>
</html>
